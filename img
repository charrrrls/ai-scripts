#!/usr/bin/env python3
"""
IMG - æ™ºèƒ½å›¾åƒåˆ†æå‘½ä»¤ - by é˜®é˜®
ä»å‰ªè´´æ¿è·å–å›¾ç‰‡å¹¶è¿›è¡ŒAIåˆ†æ

ç”¨æ³•ï¼š
  img æè¿°ä¸‹è¿™å¼ å›¾ç‰‡
  img è¯·åˆ†æè¿™ä¸ªæˆªå›¾çš„å†…å®¹å’Œå¸ƒå±€
  img è¿™æ˜¯ä»€ä¹ˆï¼Ÿ
"""

import os
import sys
import time
import threading
import tempfile
import base64
import re
from typing import Optional
from PIL import Image, ImageGrab

# æ·»åŠ è„šæœ¬ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, '/Users/leion/scripts')

from rich_utils import (print_error, print_success, print_warning, print_info, print_progress,
                       display_ai_response, display_statistics, create_streaming_callback, rich_output)
from ai_client import get_client, AIClientError
from ai_config import get_config


class ImageAnalyzer:
    """å›¾åƒåˆ†æå™¨"""
    
    def __init__(self):
        self.client = get_client()
        self.config = get_config()
        
    def get_clipboard_image(self) -> Optional[str]:
        """ä»å‰ªè´´æ¿è·å–å›¾ç‰‡å¹¶è½¬æ¢ä¸ºbase64"""
        try:
            clipboard_image = ImageGrab.grabclipboard()
            
            if clipboard_image is None:
                return None
            
            if not isinstance(clipboard_image, Image.Image):
                return None
            
            # ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶å¹¶è½¬æ¢ä¸ºbase64
            with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as temp_file:
                clipboard_image.save(temp_file.name, 'PNG')
                temp_path = temp_file.name
            
            # è¯»å–å¹¶ç¼–ç ä¸ºbase64
            with open(temp_path, 'rb') as f:
                image_data = f.read()
                base64_image = base64.b64encode(image_data).decode('utf-8')
            
            # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
            os.unlink(temp_path)
            
            return base64_image
            
        except Exception as e:
            print_error(f"è·å–å‰ªè´´æ¿å›¾ç‰‡å¤±è´¥: {e}")
            return None

    def analyze_image(self, question: str) -> None:
        """åˆ†æå‰ªè´´æ¿ä¸­çš„å›¾ç‰‡"""
        if not question:
            print_info("ç”¨æ³•: img æè¿°ä¸‹è¿™å¼ å›¾ç‰‡")
            return

        print_info("ğŸ–¼ï¸ æ­£åœ¨æ£€æµ‹å‰ªè´´æ¿å›¾ç‰‡...")
        
        # è·å–å‰ªè´´æ¿å›¾ç‰‡
        base64_image = self.get_clipboard_image()
        if not base64_image:
            print_error("âŒ å‰ªè´´æ¿ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡ï¼")
            print_info("ğŸ’¡ è¯·å…ˆæˆªå›¾æˆ–å¤åˆ¶å›¾ç‰‡ï¼Œç„¶åé‡æ–°è¿è¡Œå‘½ä»¤")
            return
        
        print_success("âœ… å·²è·å–å‰ªè´´æ¿å›¾ç‰‡")
        print_info(f"ğŸ“ åˆ†æéœ€æ±‚: {question}")

        # ç›´æ¥ä½¿ç”¨ç”¨æˆ·é—®é¢˜ï¼Œä¸æ·»åŠ é¢å¤–çš„promptæç¤ºè¯
        full_prompt = question

        # æš‚æ—¶ä½¿ç”¨æ‰¹é‡æ¨¡å¼ï¼Œé¿å…æµå¼æ˜¾ç¤ºé—®é¢˜
        self._analyze_with_batch(full_prompt, base64_image)

    def _analyze_with_stream(self, prompt: str, image_base64: str) -> None:
        """æµå¼æ¨¡å¼å›¾åƒåˆ†æ - ä¼˜åŒ–ç‰ˆ"""
        
        # ç»Ÿè®¡å˜é‡
        api_start_time = None
        first_token_time = None
        total_chars = 0
        total_tokens_estimate = 0
        streaming_callback = None
        
        try:
            print_info("ğŸ¤– Qwen-VL æ­£åœ¨åˆ†æå›¾ç‰‡...")
            
            # é¢„å…ˆåˆ›å»ºstreaming callback
            streaming_callback = create_streaming_callback("ğŸ–¼ï¸ å›¾åƒåˆ†æ")
            
            def on_chunk(chunk: str):
                nonlocal total_chars, total_tokens_estimate, first_token_time
                
                # è®°å½•é¦–ä¸ªè¯çš„å“åº”æ—¶é—´ (TTFT - Time To First Token)
                if first_token_time is None and chunk.strip():
                    first_token_time = time.time()
                
                # æ¸…ç†chunkï¼Œç§»é™¤ANSIé¢œè‰²ä»£ç è¿›è¡Œç»Ÿè®¡
                clean_chunk = re.sub(r'\x1b\[[0-9;]*m', '', chunk)
                total_chars += len(clean_chunk)
                # ç²—ç•¥ä¼°ç®—tokenæ•°ï¼ˆä¸­æ–‡çº¦2å­—ç¬¦=1tokenï¼Œè‹±æ–‡çº¦4å­—ç¬¦=1tokenï¼‰
                chinese_chars = len(re.findall(r'[\u4e00-\u9fff]', clean_chunk))
                english_chars = len(clean_chunk) - chinese_chars
                total_tokens_estimate += chinese_chars // 2 + english_chars // 4
                
                # è¾“å‡ºchunkåˆ°streaming callback
                if streaming_callback:
                    streaming_callback(chunk)
                    time.sleep(self.config.stream_delay)

            # å‘é€APIè¯·æ±‚
            api_start_time = time.time()
            result = self.client.chat_with_scenario(prompt, "vision", on_chunk, image_base64=image_base64)
            
            # å®Œæˆæµå¼è¾“å‡º
            if streaming_callback:
                streaming_callback.finish()
            
            # è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            end_time = time.time()
            duration = end_time - api_start_time if api_start_time else 0
            chars_per_sec = total_chars / duration if duration > 0 else 0
            tokens_per_sec = total_tokens_estimate / duration if duration > 0 else 0
            
            # è®¡ç®—é¦–è¯å“åº”æ—¶é—´ (TTFT)
            ttft = (first_token_time - api_start_time) if (first_token_time and api_start_time) else 0
            
            if result:
                # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                stats = {
                    "chars": total_chars,
                    "tokens": total_tokens_estimate,
                    "speed": chars_per_sec,
                    "token_speed": tokens_per_sec,
                    "ttft": ttft,  # Time To First Token
                    "duration": duration
                }
                display_statistics(stats)
            else:
                print_error("âŒ å›¾åƒåˆ†æå¤±è´¥")

        except AIClientError as e:
            if streaming_callback:
                streaming_callback.finish()
            print_error(f"âŒ å›¾åƒåˆ†æå¤±è´¥: {e}")
        except Exception as e:
            if streaming_callback:
                streaming_callback.finish()
            print_error(f"âŒ æœªçŸ¥é”™è¯¯: {e}")

    def _analyze_with_batch(self, prompt: str, image_base64: str) -> None:
        """æ‰¹é‡æ¨¡å¼å›¾åƒåˆ†æ - ç¨³å®šç‰ˆæœ¬"""
        try:
            print_info("ğŸ¤– Qwen-VL æ­£åœ¨åˆ†æå›¾ç‰‡...")
            
            # ä½¿ç”¨æ‰¹é‡æ¨¡å¼è·å–å®Œæ•´ç»“æœ
            api_start_time = time.time()
            result = self.client.chat_with_scenario(prompt, "vision", image_base64=image_base64)
            end_time = time.time()
            
            if result:
                # ä½¿ç”¨Richæ˜¾ç¤ºAIå›å¤
                display_ai_response(result, "ğŸ–¼ï¸ å›¾åƒåˆ†æ")
                
                # è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                duration = end_time - api_start_time
                total_chars = len(result)
                chinese_chars = len(re.findall(r'[\u4e00-\u9fff]', result))
                english_chars = total_chars - chinese_chars
                total_tokens_estimate = chinese_chars // 2 + english_chars // 4
                
                stats = {
                    "chars": total_chars,
                    "tokens": total_tokens_estimate,
                    "duration": duration
                }
                display_statistics(stats)
            else:
                print_error("âŒ å›¾åƒåˆ†æå¤±è´¥")
                
        except AIClientError as e:
            print_error(f"âŒ å›¾åƒåˆ†æå¤±è´¥: {e}")
        except Exception as e:
            print_error(f"âŒ æœªçŸ¥é”™è¯¯: {e}")


def main():
    """ä¸»å‡½æ•°"""
    if len(sys.argv) < 2:
        # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
        rich_output.console.print("""
[bold blue]ğŸ–¼ï¸ IMG - æ™ºèƒ½å›¾åƒåˆ†æå‘½ä»¤[/]

[green]ç”¨æ³•:[/]
  img æè¿°ä¸‹è¿™å¼ å›¾ç‰‡
  img è¯·åˆ†æè¿™ä¸ªæˆªå›¾çš„å†…å®¹å’Œå¸ƒå±€  
  img è¿™æ˜¯ä»€ä¹ˆï¼Ÿ
  img è¯·è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—

[yellow]ä½¿ç”¨æ­¥éª¤:[/]
  1. å…ˆæˆªå›¾æˆ–å¤åˆ¶å›¾ç‰‡åˆ°å‰ªè´´æ¿ (Cmd+C)
  2. è¿è¡Œ img + ä½ çš„åˆ†æéœ€æ±‚
  
[cyan]ç¤ºä¾‹:[/]
  img è¿™å¼ å›¾ç‰‡é‡Œæœ‰ä»€ä¹ˆï¼Ÿ
  img è¯·åˆ†æè¿™ä¸ªç•Œé¢çš„è®¾è®¡ç‰¹ç‚¹
  img è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—å†…å®¹
""")
        return

    # è·å–ç”¨æˆ·é—®é¢˜ï¼ˆåˆå¹¶æ‰€æœ‰å‚æ•°ï¼‰
    question = " ".join(sys.argv[1:])
    
    # åˆ›å»ºåˆ†æå™¨å¹¶æ‰§è¡Œåˆ†æ
    analyzer = ImageAnalyzer()
    analyzer.analyze_image(question)


if __name__ == "__main__":
    main()